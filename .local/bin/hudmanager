#!/bin/bash

modkey=133
hudbar_pid=$1
statsbar_pid=$2

# Function to wait $1 seconds then close all polybars
hide_after_delay() {
  sleep $1
  polybar-msg cmd hide &>/dev/null
}

# Check polybar ipc works and hide bars
polybar-msg -p "$hudbar_pid" cmd hide || exit 1
polybar-msg -p "$statsbar_pid" cmd hide || exit 1

# Loop forever
while read key
do

  # Wait for mod key press
  [[ "$key" != "$modkey" ]] && continue

  # Kill any previous waiting jobs
  jobs &>/dev/null
  job_ids=$(jobs -p)
  [[ "$job_ids" ]] && kill "$job_ids"

  # Open hud bar
  delay=0.2
  polybar-msg -p "$hudbar_pid" cmd show &>/dev/null

  # If there were waiting jobs, mod key press was in quick succession so open stats bar
  if [[ "$job_ids" ]]
  then
    delay=2.0
    polybar-msg -p "$statsbar_pid" cmd show &>/dev/null
  fi

  # Wait for mod key release
  while read key
  do
    [[ "$key" == "$modkey" ]] && break
  done < <(xinput test-xi2 --root 3 | gawk '/RawKeyRelease/ {getline; getline; print $2; fflush()}')

  # Start a new job which waits $delay seconds before hiding the bars
  hide_after_delay $delay &

done < <(xinput test-xi2 --root 3 | gawk '/RawKeyPress/ {getline; getline; print $2; fflush()}')

