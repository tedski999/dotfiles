#!/bin/bash

modkey=133
i3modefile="$HOME/.cache/i3mode"

# Check polybar ipc works
mainbar_pid="$1"
polybar-msg -p "$mainbar_pid" cmd show || exit 1

# Save current i3 mode

# Function to wait $1 seconds then close all polybars
hide_after_delay() {
  sleep "$1"

  # Wait until we're in i3 default binding mode
  while [ "$(tail -n 1 "$i3modefile")" != "default" ]; do
    sleep 0.5
  done

  polybar-msg cmd hide &>/dev/null
}

# Loop forever
while read key
do

  # Wait for mod key press
  [ "$key" != "$modkey" ] && continue

  # Kill any previous waiting jobs
  jobs &>/dev/null
  job_ids="$(jobs -p)"
  [ "$job_ids" ] && kill "$job_ids"

  # Open all bars except the main bar
  delay=0.2
  for mqueue in /tmp/polybar_mqueue.*; do
    [ "$mqueue" != /tmp/polybar_mqueue."$mainbar_pid" ] && echo "cmd:show" >"$mqueue"
  done

  # If there were waiting jobs, mod key press was in quick succession so open stats bar
  if [ "$job_ids" ]
  then
    delay=1.0
    polybar-msg -p "$mainbar_pid" cmd show &>/dev/null
  fi

  # Wait for mod key release
  while read key; do
    [ "$key" == "$modkey" ] && break
  done < <(xinput test-xi2 --root 3 | gawk '/RawKeyRelease/ {getline; getline; print $2; fflush()}')

  # Start a new job which waits $delay seconds before hiding the bars
  hide_after_delay "$delay" &

done < <(xinput test-xi2 --root 3 | gawk '/RawKeyPress/ {getline; getline; print $2; fflush()}')

