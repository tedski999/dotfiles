#!/bin/bash

# Protect user from an empty battery by sending notifications and entering hibernation

old_capacity=100
notification_id=$RANDOM

while true; do
	state="$(cat /sys/class/power_supply/BAT0/status)"

	if [[ "$state" == "Discharging" ]]; then
		capacity="$(cat /sys/class/power_supply/BAT0/capacity)"
		if [[ "$old_capacity" -gt 2 && "$capacity" -le 2 ]]; then
			for i in {5..1}; do
				notify-send --icon "battery-000" --urgency "critical" --replace-id "$notification_id" "Battery empty!" "Hibernating in $i..."
				sleep 1
			done
			systemctl hibernate
		elif [[ "$old_capacity" -gt 10 && "$capacity" -le 10 ]]; then
			notify-send --icon "battery-010" --urgency "critical" --replace-id "$notification_id" --expire-time 0 "Battery critical!" "Emergency hibernation imminent!"
		elif [[ "$old_capacity" -gt 20 && "$capacity" -le 20 ]]; then
			notify-send --icon "battery-020" --urgency "normal" --replace-id "$notification_id" "Battery low!" "Consider finding a charger?"
		fi
	fi

	old_capacity="$capacity"
	sleep 5
done
