#!/bin/bash

# Automatically backup home directory regularly with Borg

notification_id=$RANDOM
export BORG_REPO="$HOME/.local/backups"
[[ -d "$BORG_REPO" ]] || borg init --encryption none

trap "export BACKUPMANAGER_MANAUAL=true" 10 # USR1

while true; do
	if [[ -n "$BACKUPMANAGER_MANAUAL" ]]; then
		notify-send --icon "backup" --replace-id "$notification_id" --expire-time 0 "Creating new backup..." "Saving to $BORG_REPO"
	fi

	borg create ::"{hostname}-{user}-{now}" "$HOME" \
		--exclude-caches \
		--exclude "$HOME/.cache/*" \
		--exclude "$HOME/Games/*" \
		--exclude "$HOME/.config/BraveSoftware/*" \
		--exclude "$HOME/.config/discord/*" \
		--exclude "$HOME/.local/share/Steam/*"
	create_rc="$?"
	borg prune --keep-within 1d --keep-daily 7 --keep-weekly 4 --keep-monthly 1 --keep-yearly 1
	prune_rc="$?"
	borg compact
	compact_rc="$?"

	if [[ "$create_rc" == "2" || "$prune_rc" == "2" || "$compact_rc" == "2" ]]; then
		notify-send --icon "backup" --urgency "critical" --replace-id "$notification_id" --expire-time 0 "Failed to create backup!" "Please check local backup system"
	elif [[ -n "$BACKUPMANAGER_MANAUAL" ]]; then
		notify-send --icon "backup" --replace-id "$notification_id" --expire-time 0 "New backup created successfully" "Saved to $BORG_REPO"
	fi
	export BACKUPMANAGER_MANAUAL=

	sleep 600 &
	wait
done
